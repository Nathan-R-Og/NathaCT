#!/usr/bin/env bash

if [[ ! -f "baserom.jp.z64" ]]; then
    echo "Error: baserom.jp.z64 not found in current directory"
    exit 1
fi

expected_hash="a1faf5c4ca961ab2c029c84ecfa556755e7f70c8"
actual_hash=$(sha1sum baserom.jp.z64 | awk '{ print $1 }')

if [[ "$actual_hash" != "$expected_hash" ]]; then
    echo "Error: baserom.jp.z64 has an invalid SHA1 hash"
    exit 1
fi

if [[ "$1" == "--mod" ]]; then
    if [[ ! -d src/mod ]]; then
        mkdir -p src/mod
    elif [[ -d src/mod/ct1-JP-SpeedrunMod ]]; then
        echo "Directory src/mod/ct1-JP-SpeedrunMod found."
    fi

    echo "Creating include/mod.h"
    echo "// Auto generated by configure bash" > include/mod.h
    echo "#define MOD" >> include/mod.h
    echo "void mod_boot_func(void);" >> include/mod.h
    echo "void mod_main_per_frame(void);" >> include/mod.h
    # Check if --sd flag is present
    if [[ "$2" == "--sd" ]]; then
        echo "#define USE_SD_CARD TRUE //set to true to build with sd card funcs" >> include/mod.h
    else
        echo "#define USE_SD_CARD FALSE //set to false to build without sd card funcs" >> include/mod.h
    fi

    gcc tools/n64crc/n64crc.c -o tools/n64crc/n64crc.exe
    python3 tools/splat/split.py chameleontwist.jp.yaml
    python3 mod_configure.py "$@"
    

else
    echo "Creating include/mod.h"
    echo "// Auto generated by configure bash" > include/mod.h
    python3 configure.py "$@"
fi
